name: Migration Preview

on:
  pull_request:
    paths:
      - 'migrations/**'

jobs:
  preview-migration:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      
      - name: Show pending migrations
        run: |
          export NES_DB_PATH=./nes-db
          nes migration list --pending
      
      - name: Run migrations
        id: run
        continue-on-error: true
        run: |
          export NES_DB_PATH=./nes-db
          echo y | nes migration run --all 2>&1 | tee migration_output.txt
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: 'Upload Artifact'
        id: artifact-upload-step
        uses: actions/upload-artifact@v4
        with:
          name: migration-logs
          path: nes-db/v2/migration-logs
      
      - name: Post results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const artifactUrl = `${{ steps.artifact-upload-step.outputs.artifact-url }}`;
            
            let output = '';
            try {
              output = fs.readFileSync('migration_output.txt', 'utf8');
              if (output.length > 65536) {
                output = output.substring(0, 65536) + '\n\n... (output truncated)';
              }
            } catch (error) {
              output = 'No migration output found';
            }
            
            const exitCode = '${{ steps.run.outputs.exit_code }}';
            const success = exitCode === '0';
            const status = success ? 'âœ… Migration Preview' : 'âš ï¸ Migration Preview';
            
            const body = `## ${status}
            
            \`\`\`
            ${output}
            \`\`\`
            
            ğŸ“Š [View full logs](${runUrl})
            ğŸ“¦ [Download migration logs](${artifactUrl})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
